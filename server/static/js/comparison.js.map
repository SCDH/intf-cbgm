{"version":3,"sources":["../../es6/comparison.es6"],"names":[],"mappings":"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","file":"comparison.js","sourcesContent":["/**\n * Comparison of 2 witnesses.  This module shows a table with a global\n * comparison of two witnesses: in how many passages do they differ, how many\n * are older / younger? There is also a drill-down table for each range with\n * more detail about the differing passages.\n *\n * @module comparison\n * @author Marcello Perathoner\n */\n\ndefine ([\n    'jquery',\n    'd3',\n    'tools',\n    'datatables.net',\n    'datatables.net-bs',\n    'datatables.net-buttons',\n    'datatables.net-buttons-bs',\n    'datatables.net-buttons-html5',\n    'datatables.net-buttons-print',\n    'css!bootstrap-css',\n    'css!datatables-bs-css',\n    'css!datatables-buttons-bs-css',\n    'css!site-css',\n    'css!comparison-css'],\n\nfunction ($, d3, tools) {\n    var module = {};\n\n    var default_table_options = {\n        'autoWidth'    : true,\n        'deferRender'  : true,\n        'info'         : false,\n        'lengthChange' : false,\n        'ordering'     : true,\n        'paging'       : false,\n        'scrollX'      : false,\n        'searching'    : false,\n    };\n\n    var default_buttons = [\n        {\n            'extend'        : 'copy',\n            'className'     : 'btn btn-primary btn-comparison-copy',\n            'exportOptions' : { 'columns' : '.exportable' },\n        },\n        {\n            'extend'        : 'csv',\n            'className'     : 'btn btn-primary btn-comparison-csv',\n            'exportOptions' : { 'columns' : '.exportable' },\n        },\n        {\n            'extend'        : 'print',\n            'className'     : 'btn btn-primary btn-comparison-print',\n            'exportOptions' : { 'columns' : '.exportable' },\n            'autoPrint'     : false,\n        },\n    ];\n\n    /**\n     * Return a direction marker, <, =, or >.\n     *\n     * @function dir\n     *\n     * @param {integer} older - How many passages are older.\n     * @param {integer} newer - How many passages are newer.\n     *\n     * @return Direction marker.\n     */\n\n    function dir (older, newer) {\n        if (older > newer) {\n            return '>';\n        }\n        if (older < newer) {\n            return '<';\n        }\n        return '=';\n    }\n\n    /**\n     * Row conversion function.  Convert numeric values to numeric types and add\n     * calculated fields.\n     *\n     * @function main_row_conversion\n     *\n     * @return The converted row\n     */\n\n    function main_row_conversion (d) {\n        return {\n            'range'     : d.range,\n            'length1'   : +d.length1,\n            'length2'   : +d.length2,\n            'common'    : +d.common,\n            'equal'     : +d.equal,\n            'older'     : +d.older,\n            'newer'     : +d.newer,\n            'norel'     : +d.norel,\n            'unclear'   : +d.unclear,\n            'affinity'  : Math.round (d.affinity * 100000) / 1000,\n            'rank'      : +d.rank,\n            'direction' : dir (+d.older, +d.newer),\n        };\n    }\n\n    /**\n     * Detail row conversion function.  Convert numeric values to numeric types\n     * and add calculated fields.\n     *\n     * @function detail_row_conversion\n     *\n     * @return The converted row\n     */\n\n    function detail_row_conversion (d) {\n        return {\n            'pass_id'       : d.pass_id,\n            'pass_hr'       : d.pass_hr,\n            'labez_clique1' : d.labez_clique1,\n            'lesart1'       : d.lesart1,\n            'labez_clique2' : d.labez_clique2,\n            'lesart2'       : d.lesart2,\n            'older'         : d.older   === 'True',\n            'newer'         : d.newer   === 'True',\n            'norel'         : d.norel   === 'True',\n            'unclear'       : d.unclear === 'True',\n        };\n    }\n\n    /**\n     * Initialize the details table structure.  This has to be done only once.\n     * On navigation we'll throw all detail tables away.\n     *\n     * @function init_details_table\n     *\n     * @param {jQuery} $detailsTable - The details table root node, which is not\n     * really a table node but a tr node containing a table further down.\n     */\n\n    function init_details_table ($detailsTable) {\n        var buttons = default_buttons.slice ();\n        var caption = $ ('caption span.caption', $detailsTable).text ().replace (/\\s+/g, ' ');\n        buttons[1].filename = caption;\n        buttons[2].title    = caption;\n        var details_table = $detailsTable.find ('table').DataTable ( // eslint-disable-line new-cap\n            $.extend ({}, default_table_options, {\n                'columns' : [\n                    {\n                        'data' : function (r, type /* , val, meta */) {\n                            if (type === 'sort') {\n                                return tools.natural_sort (r.pass_id);\n                            }\n                            return '<a href=\"coherence#' + r.pass_id + '\">' + r.pass_hr + '</a>';\n                        },\n                        'class' : 'passage',\n                    },\n                    {\n                        'data'  : 'lesart1',\n                        'class' : 'lesart lesart1',\n                    },\n                    {\n                        'data'  : 'labez_clique1',\n                        'class' : 'ms ms1',\n                    },\n                    {\n                        'data'   : null,\n                        'class'  : 'direction',\n                        'render' : function (r) {\n                            if (r.older) {\n                                return '>';\n                            }\n                            if (r.newer) {\n                                return '<';\n                            }\n                            if (r.unclear) {\n                                return '?';\n                            }\n                            return '< >';\n                        },\n                    },\n                    {\n                        'data'  : 'labez_clique2',\n                        'class' : 'ms ms2',\n                    },\n                    {\n                        'data'  : 'lesart2',\n                        'class' : 'lesart lesart2',\n                    },\n                ],\n                'order'      : [[0, 'asc']],\n                'createdRow' : function (r, d /* , index */) {\n                    var $row = $ (r);\n                    $row.toggleClass ('newer', d.newer);\n                    $row.toggleClass ('older', d.older);\n                },\n                'buttons' : {\n                    'buttons' : buttons,\n                    'dom'     : {\n                        'container' : {\n                            'className' : 'btn-group btn-group-xs',\n                        },\n                    },\n                },\n            })\n        );\n\n        details_table.buttons ().container ().appendTo (\n            $ ('div.toolbar-comparison-detail', $detailsTable)\n        );\n        return details_table;\n    }\n\n    /**\n     * Opens a table containing a detailed view of one range.\n     *\n     * @function toggle_details_table\n     */\n\n    function toggle_details_table () {\n        var $tr    = $ (this).closest ('tr');\n        var $table = $tr.closest ('table');\n        var table  = $table.DataTable (); // eslint-disable-line new-cap\n        var row    = table.row ($tr);\n\n        if (row.child.isShown ()) {\n            $ ('div.slider', row.child ()).slideUp (function () {\n                row.child.hide ();\n                $tr.removeClass ('shown');\n            });\n        } else {\n            if ($tr.hasClass ('csv-loaded')) {\n                $tr.addClass ('shown');\n                row.child.show ();\n                $ ('div.slider', row.child ()).slideDown ();\n                return;\n            }\n\n            var params2 = {\n                'ms1'   : module.ms1.hsnr,\n                'ms2'   : module.ms2.hsnr,\n                'range' : $tr.attr ('data-range'),\n            };\n\n            var $detailsTable = create_details_table (module.ms1.hs, module.ms2.hs, params2.range);\n            row.child ($detailsTable, 'no-padding').show ();\n            $tr.addClass ('shown');\n\n            d3.csv ('comparison-detail.csv?' + $.param (params2), detail_row_conversion, function (error, csv) {\n                if (error) {\n                    throw error;\n                }\n                $tr.addClass ('csv-loaded');\n                var details_table = init_details_table ($detailsTable);\n                details_table.clear ().rows.add (csv).draw ();\n                $ ('div.slider', row.child ()).slideDown ();\n            });\n        }\n    }\n\n    /**\n     * Return a skeleton for the main table.\n     *\n     * @function create_main_table\n     *\n     * @return {jQuery} The HTML skeleton.\n     */\n\n    function create_main_table () {\n        return $ (`\n            <table class=\"comparison table table-bordered table-condensed table-hover\" cellspacing=\"0\">\n              <thead>\n                <tr>\n                  <th class=\"details-control\"></th>\n\n                  <th class=\"range exportable\">Chapter</th>\n                  <th class=\"direction exportable\">Dir</th>\n                  <th class=\"rank exportable\">NR</th>\n\n                  <th class=\"perc exportable\">Perc</th>\n                  <th class=\"eq exportable\">Eq</th>\n                  <th class=\"common exportable\">Pass</th>\n\n                  <th class=\"newer exportable\">W1&lt;W2</th>\n                  <th class=\"older exportable\">W1&gt;W2</th>\n                  <th class=\"uncl exportable\">Uncl</th>\n                  <th class=\"norel exportable\">NoRel</th>\n                  <!--\n                    <th class=\"length length1 exportable\">W1 defined</th>\n                    <th class=\"length length2 exportable\">W2 defined</th>\n                  -->\n                </tr>\n              </thead>\n              <tbody>\n              </tbody>\n            </table>`);\n    }\n\n    /**\n     * Return a skeleton for a drill-down table.\n     *\n     * @function create_details_table\n     *\n     * @param {string} ms1   - Name of the first manuscript to compare.\n     * @param {string} ms2   - Name of the second manuscript to compare.\n     * @param {string} range - The range to compare.\n     *\n     * @return {jQuery} The HTML skeleton.\n     */\n\n    function create_details_table (ms1, ms2, range) {\n        return $ (`\n            <tr class=\"no-padding\">\n              <td class=\"no-padding\"></td>\n              <td class=\"no-padding\" colspan=\"12\">\n                <div class=\"slider\">\n                  <table cellspacing=\"0\" width=\"100%\"\n                          class=\"comparison-detail table table-bordered table-condensed table-hover\">\n                    <caption>\n                      <span class=\"caption\">\n                        Comparison of ${ms1} and ${ms2} in Chapter ${range}\n                      </span>\n                      <div class=\"btn-toolbar toolbar toolbar-comparison-detail\" role=\"toolbar\">\n                      </div>\n                    </caption>\n                    <thead>\n                      <tr>\n                        <th class=\"passage exportable\">Passage</th>\n                        <th class=\"lesart lesart1 exportable\">Lesart</th>\n                        <th class=\"ms ms1 exportable\">${ms1}</th>\n                        <th class=\"direction exportable\">Dir</th>\n                        <th class=\"ms ms2 exportable\">${ms2}</th>\n                        <th class=\"lesart lesart2 exportable\">Lesart</th>\n                      </tr>\n                    </thead>\n                  </table>\n                </div>\n              </td>\n            </tr>\n        `);\n    }\n\n    /**\n     * Initialize the main table structure.  This has to be done only once.  On\n     * navigation we only replace the table data.\n     *\n     * @function init_main_table\n     */\n\n    function init_main_table () {\n        var $table = create_main_table ();\n        $table.appendTo ($ ('div.panel-comparison'));\n        var $tbody = $table.find ('tbody');\n\n        var table = $table.DataTable ($.extend ({}, default_table_options, { // eslint-disable-line new-cap\n            'columns' : [\n                {\n                    'class'          : 'details-control',\n                    'orderable'      : false,\n                    'data'           : null,\n                    'defaultContent' : '',\n                },\n\n                {\n                    'data' : function (r, type /* , val, meta */) {\n                        if (type === 'sort') {\n                            return tools.natural_sort (r.range);\n                        }\n                        return r.range;\n                    },\n                    'class' : 'range',\n                },\n                {\n                    'data'  : 'direction',\n                    'class' : 'direction',\n                },\n                {\n                    'data'  : 'rank',\n                    'class' : 'equal',\n                },\n\n                {\n                    'data'  : 'affinity',\n                    'class' : 'equal',\n                },\n                {\n                    'data'  : 'equal',\n                    'class' : 'equal',\n                },\n                {\n                    'data'  : 'common',\n                    'class' : 'common',\n                },\n\n                {\n                    'data'  : 'newer',\n                    'class' : 'newer',\n                },\n                {\n                    'data'  : 'older',\n                    'class' : 'older',\n                },\n                {\n                    'data'  : 'unclear',\n                    'class' : 'unclear',\n                },\n                {\n                    'data'  : 'norel',\n                    'class' : 'norel',\n                },\n                /*\n                {\n                    'data'  : 'length1',\n                    'class' : 'length length1',\n                },\n                {\n                    'data'  : 'length2',\n                    'class' : 'length length2',\n                },\n                */\n            ],\n            'order'      : [[1, 'asc']],\n            'createdRow' : function (row, data, dummy_index) {\n                var $row = $ (row);\n                $row.attr ('data-range', data.range);\n                $row.toggleClass ('older', data.older > data.newer);\n                $row.toggleClass ('newer', data.older < data.newer);\n            },\n            'buttons' : {\n                'buttons' : default_buttons,\n                'dom'     : {\n                    'container' : {\n                        'className' : 'btn-group btn-group-xs',\n                    },\n                },\n            },\n        }));\n\n        table.buttons ().container ().appendTo ($ ('div.toolbar-comparison'));\n\n        $tbody.on ('click', 'td.details-control', toggle_details_table);\n    }\n\n    /**\n     * Called after navigation.  Redraws the whole page.\n     *\n     * @function on_navigation\n     */\n\n    function on_navigation () {\n        var hash = window.location.hash.substring (1);\n        if (hash) {\n            var p = tools.deparam (hash);\n\n            var p1 = $.getJSON ('manuscript.json/' + p.ms1, function (json) {\n                module.ms1 = json.data;\n            });\n            var p2 = $.getJSON ('manuscript.json/' + p.ms2, function (json) {\n                module.ms2 = json.data;\n            });\n\n            $.when (p1, p2).done (function () {\n                // update the input form\n                var $form = $ ('form.manuscripts-selector');\n                $ ('input[name=\"ms1\"]', $form).val (module.ms1.hs + '.');\n                $ ('input[name=\"ms2\"]', $form).val (module.ms2.hs + '.');\n\n                // update the headers\n                var caption  = tools.format ('Comparison of {ms1} and {ms2}', {\n                    'ms1' : module.ms1.hs,\n                    'ms2' : module.ms2.hs,\n                });\n                $ ('title').text (caption);\n                $ ('h1 span.caption').text (caption);\n                $ ('div.panel-comparison-header span.caption').text (caption);\n\n                // reload table\n                var url = 'comparison-summary.csv?' + $.param ({\n                    'ms1' : module.ms1.hsnr,\n                    'ms2' : module.ms2.hsnr,\n                });\n                d3.csv (url, main_row_conversion, function (error, csv) {\n                    if (error) {\n                        throw error;\n                    }\n                    var table = $ ('table.comparison');\n                    var data_table = table.DataTable (); // eslint-disable-line new-cap\n                    data_table.clear ().rows.add (csv).draw ();\n                    /*\n                    table.find ('th.older').text   (module.ms1.hs + ' older');\n                    table.find ('th.newer').text   (module.ms2.hs + ' older');\n                    table.find ('th.length1').text (module.ms1.hs + ' defined');\n                    table.find ('th.length2').text (module.ms2.hs + ' defined');\n                    */\n                });\n            });\n        }\n    }\n\n    /**\n     * Init the navigation elements.  Also listen for hashtag events.\n     *\n     * @function init_nav\n     */\n\n    function init_nav () {\n        function fix (s) {\n            var re = /^\\d+$/;\n            s += '';\n            if (re.test (s) && s.length < 6) {\n                return s + '.';\n            }\n            return s;\n        }\n\n        // User hit 'Go'\n        $ ('form.manuscripts-selector').on ('submit', function (event) {\n            var q = $ (event.currentTarget).serializeArray ();\n            q[0].value = fix (q[0].value);\n            q[1].value = fix (q[1].value);\n            window.location.hash = '#' + $.param (q);\n            event.preventDefault ();\n        });\n\n        // From above or user hit back-button, etc.\n        $ (window).on ('hashchange', function () {\n            $ (document).trigger ('ntg.comparison.changed');\n        });\n\n        // Hook\n        $ (document).on ('ntg.comparison.changed', function (/* event */) {\n            on_navigation ();\n        });\n    }\n\n    /**\n     * Initialize the module.\n     *\n     * @function init\n     */\n    function init () {\n        init_nav ();\n        init_main_table ();\n        on_navigation ();\n    }\n\n    module.init = init;\n    return module;\n});\n"]}