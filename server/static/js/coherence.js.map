{"version":3,"sources":["../../es6/coherence.js"],"names":[],"mappings":"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","file":"coherence.js","sourcesContent":["/**\n * This module is the main entry point and displays the main page.  This module\n * is only a container for the other modules that actually display the gadgets.\n *\n * @module coherence\n * @author Marcello Perathoner\n */\n\ndefine ([\n    'jquery',\n    'd3-common',\n    'd3-stemma',\n    'd3-chord',\n    'apparatus',\n    'navigator',\n    'panel',\n    'relatives',\n    'textflow',\n    'local-stemma',\n    'notes',\n    'css!bootstrap-css',\n    'css!jquery-ui-css',\n    'css!site-css',\n    'css!coherence-css',\n],\n\nfunction ($, d3common, d3stemma, d3chord,\n    apparatus, navigator, panel, relatives, textflow, locstem, notes) {\n    let module = {}; // singleton\n\n    /**\n     * Create a new popup managed by the relatives module.\n     *\n     * We have to create these dynamically because there may be many open at once.\n     *\n     * @function create_relatives_popup\n     *\n     * @param {integer} ms_id - The manuscript id\n     * @param {Object} passage - The passage\n     * @param {jQuery} target - An element. The popup will be positioned relative to this element.\n     *\n     * @returns {Promise} Resolved when popup is created.\n     */\n\n    function create_relatives_popup (ms_id, passage, target) {\n        let $popup = $ ($ ('#relatives-template').html ());\n        $popup.hide ().appendTo ('#floating-panels').fadeIn ();\n        $popup.draggable ();\n        $popup.data ('ms-id', ms_id);\n        let instance = relatives.init (panel.init ($popup));\n        instance.load (passage).done (() => {\n            instance.position_popup (target);\n        });\n        panel.create_panel_controls ($popup);\n        // notify others\n        relatives.changed ();\n    }\n\n    /**\n     * Initialize the module.\n     *\n     * @function init\n     */\n    function init () {\n        $ (document).off ('.data-api');\n\n        module.navigator    = navigator.init ();\n\n        // create the panels\n\n        module.apparatus    = apparatus.init (\n            panel.init ($ ('div.panel-apparatus'))\n        );\n\n        module.local_stemma = locstem.init  (\n            panel.init ($ ('div.panel-local-stemma')),\n            d3stemma,\n            'ls_'\n        );\n\n        // only editors will have this\n        if (is_editor && $ ('div.panel-notes').length) {\n            module.notes = notes.init  (\n                panel.init ($ ('div.panel-notes')),\n                'notes_'\n            );\n        }\n\n        module.vtextflow    = textflow.init  (\n            panel.init ($ ('div.panel-variant-textflow')),\n            d3stemma,\n            'vtf_',\n            true,\n            true\n        );\n\n        module.vtextflow2   = textflow.init  (\n            panel.init ($ ('div.panel-variant-textflow-2')),\n            d3chord,\n            'vtf2_',\n            true,\n            true\n        );\n\n        module.ltextflow    = textflow.init  (\n            panel.init ($ ('div.panel-local-textflow')),\n            d3stemma,\n            'tf_',\n            false,\n            false\n        );\n\n        module.gtextflow    = textflow.init  (\n            panel.init ($ ('div.panel-global-textflow')),\n            d3stemma,\n            'gtf_',\n            true,\n            false\n        );\n\n        panel.create_panel_controls ($ ('div.panel'));\n\n        // this panel is closed by default\n        $ ('div.panel-variant-textflow-2 .panel-slidable').slideUp ();\n        module.vtextflow2.visible = false;\n\n        // insert css for color palettes\n        d3common.insert_css_palette (\n            d3common.generate_css_palette (\n                d3common.labez_palette,\n                d3common.cliques_palette\n            )\n        );\n\n        // install event handlers\n\n        // Click on a ms. in the apparatus or in a relatives popup.\n        $ (document).on ('click', '.ms[data-ms-id]', function (event) {\n            event.stopPropagation ();\n            let ms_id = $ (event.target).attr ('data-ms-id');\n            create_relatives_popup (ms_id, module.navigator.passage, event.target);\n        });\n\n        // Click on a comparison row in the apparatus or in a relatives popup.\n        $ (document).on ('click', 'tr.comparison[data-ms2-id]', function (event) {\n            event.stopPropagation ();\n            let ms1_id = $ (event.currentTarget).attr ('data-ms1-id');\n            let ms2_id = $ (event.currentTarget).attr ('data-ms2-id');\n            let win = window.open ('comparison#ms1=id' + ms1_id + '&ms2=id' + ms2_id, '_blank');\n            win.focus ();\n        });\n\n        // Click on a node in the textflow diagram.\n        $ (document).on ('click', 'div.panel-textflow g.node', function (event) {\n            let ms_id = $ (event.currentTarget).attr ('data-ms-id'); // the g.node, not the circle\n            create_relatives_popup (ms_id, module.navigator.passage, event.currentTarget);\n        });\n\n        // Click on canvas to close context menus\n        $ (document).on ('click', function (dummy_event) {\n            let $menu = $ ('table.contextmenu');\n            $menu.fadeOut (() => $menu.remove ());\n        });\n\n        // The user navigated to a new passage.\n        $ (document).on ('ntg.panel.reload', (event, passage) => {\n            $ ('div.panel').trigger ('ntg.panel.reload', passage);\n        });\n\n        // Simulate user navigation set the passage on all modules.\n        if (window.location.hash) {\n            let hash = window.location.hash.substring (1);\n            module.navigator.set_passage (hash);\n        }\n    }\n\n    module.init = init;\n\n    window.coherence = module;\n\n    return module;\n});\n"]}